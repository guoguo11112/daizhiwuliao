<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- å›¾ç‰‡åŒºåŸŸ -->
    <div class="image-area">
        <div style="font-size: 86px;">ã€æœ‰é“é¢†ä¸–ã€‘åœ¨å¸ç‰©æ–™åº“å­˜ç®¡ç†</div>
    </div>
    <meta charset="UTF-8">
    <title>å®æ—¶åº“å­˜ç®¡ç†</title>
    <style>
        /* å•†åŠ¡é£æ ¼æ ·å¼ */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            text-align: left;
            padding-bottom: 15px;
            margin-bottom: 30px;
            border-bottom: 4px solid #3498db;
        }
        .search-area {
            margin: 25px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .search-box {
            flex: 1;
            display: flex;
            gap: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: center; /* æ”¹ä¸ºå±…ä¸­ */
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle; /* å‚ç›´å±…ä¸­ */
        }

        /* æ“ä½œæŒ‰é’®åˆ—ä¿æŒåŸæœ‰å¸ƒå±€ */
        tr td:last-child {
            margin-top: 50px;
            height: 80px;
            text-align: space-between; /* æ“ä½œæŒ‰é’®ä¿æŒå·¦å¯¹é½ */
            justify-content: center;
            display: block;
            gap: 8px;
            padding: 5px;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            border-radius: 4px;
        }
        tr:hover {
            background-color: #f5faff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 25px rgba(0,0,0,0.2);
            min-width: 320px;
        }
        .filter-area {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select, input[type="text"], input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            width: 200px;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        .image-area {
            margin-top: 40px;
            height: 150px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            padding: 20px;
        }

        #quantityInput {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        /* æ–°å¢å›¾ç‰‡ç›¸å…³æ ·å¼ */
        .material-image {
            display: block;
            margin: 0 auto;
            max-width: 150px;
            max-height: 100px;
            object-fit: contain;
            border-radius: 1px;
            transition: transform 0.3s ease-in-out;
            padding: 1px 0; /* æ–°å¢ä¸Šä¸‹é—´è· */
        }

        tr td:nth-child(3) { /* å›¾ç‰‡åˆ—å•å…ƒæ ¼ */
            padding: 1px 15px !important; /* ä¸Šä¸‹1pxé—´è· */
            vertical-align: middle;
        }
        .material-image:hover {
            transform: scale(1.5); /* æ‚¬åœæ”¾å¤§ 1.5 å€ */
        }
        .upload-btn-wrapper {
            position: relative;
            height: 24px; /* ç¼©å°é«˜åº¦ */
            margin-top: 2px;
        }

        .upload-btn {
            position: absolute;
            right: 0;
            bottom: 0;
            background: #27ae60;
            padding: 2px 4px;
            font-size: 10px;
            border-radius: 3px;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ å®æ—¶åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-area">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥ç¼–ç /åç§°">
                <select id="subjectFilter">
                    <option value="">æ‰€æœ‰å­¦ç§‘</option>
                    <option>è¯­æ–‡</option>
                    <option>æ•°å­¦</option>
                    <option>è‹±è¯­</option>
                    <option>ç‰©ç†</option>
                    <option>åŒ–å­¦</option>
                    <option>ç”Ÿç‰©</option>
                    <option>åœ°ç†</option>
                    <option>æ”¿æ²»</option>
                    <option>å†å²</option>
                </select>
                <select id="versionFilter">
                    <option value="">æ‰€æœ‰ç‰ˆæœ¬</option>
                    <option>é«˜é¢‘</option>
                    <option>å…¨å½’çº³</option>
                    <option>è®²é€</option>
                    <option>åå¸ˆè¯¾å ‚</option>
                </select>
                <button onclick="performSearch()">ğŸ” æœç´¢</button>
                <button onclick="document.getElementById('batchImportFile').click()">ğŸ“¥ æ‰¹é‡å…¥åº“</button>
                <input type="file" id="batchImportFile" accept=".csv,.xlsx" style="display:none" onchange="handleBatchImport(event)">
                <button onclick="document.getElementById('batchExportFile').click()">ğŸ“¤ æ‰¹é‡å‡ºåº“</button>
                <input type="file" id="batchExportFile" accept=".csv,.xlsx" style="display:none" onchange="handleBatchExport(event)">
                <button onclick="exportInventory()">ğŸ“Š å¯¼å‡ºåº“å­˜</button>
            </div>
        </div>
        <div id="batchConfirmModal" class="modal">
            <h3>ğŸ“„ ç¡®è®¤æ‰¹é‡æ“ä½œ</h3>
            <table id="batchPreviewTable"></table>
            <div style="text-align:right; margin-top:20px">
                <button onclick="executeBatch()">âœ… ç¡®è®¤æ‰§è¡Œ</button>
                <button onclick="closeBatchModal()" style="background:#95a5a6">âŒ å–æ¶ˆ</button>
            </div>
        </div>
        <!-- åº“å­˜è¡¨æ ¼ -->
        <table id="inventoryTable">
            <thead>
                <tr>
                    <th>ç¼–ç </th>
                    <th>ç‰©æ–™åç§°</th>
                    <th>å›¾ç‰‡</th>  <!-- æ–°å¢å›¾ç‰‡åˆ— -->
                    <th>åº“å­˜</th>
                    <th>ç‰ˆæœ¬</th>
                    <th>å­¦ç§‘</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>

        <!-- å‡ºå…¥åº“å¼¹çª— -->
        <div id="operationModal" class="modal">
            <h3 id="modalTitle"></h3>
            <input type="number" id="quantityInput" min="1" value="1">
            <div style="text-align:right; margin-top:20px">
                <button onclick="verifyAuth()">âœ… ç¡®è®¤</button>
                <button onclick="closeModal()" style="background:#95a5a6">âŒ å–æ¶ˆ</button>
            </div>
        </div>

        <!-- å‡ºå…¥åº“è®°å½• -->
        <h2>ğŸ“ æ“ä½œè®°å½•</h2>
        <div class="filter-area">
            <input type="date" id="dateFilter">
            <button onclick="filterRecords()">â³ æŒ‰æ—¥æœŸç­›é€‰</button>
            <button onclick="clearFilter()">ğŸ”„ æ˜¾ç¤ºå…¨éƒ¨</button>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>ç‰©æ–™ç¼–ç </th>
                    <th>ç‰©æ–™åç§°</th> <!-- æ–°å¢åˆ— -->
                    <th>æ•°é‡</th>
                    <th>æ“ä½œäºº</th>
                </tr>
            </thead>
            <tbody id="recordBody"></tbody>
        </table>
        <button onclick="exportRecords()">ğŸ“„ å¯¼å‡º Excel</button>

    <!-- æ“ä½œè®°å½•åˆ†é¡µæ§ä»¶ -->
    <div class="pagination-controls">
        <span>æ¯é¡µæ˜¾ç¤ºï¼š</span>
        <select id="recordsPerPageSelect" onchange="changeRecordsPerPage()">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="20">20</option>
            <option value="50">50</option>
        </select>
        <span>æ¡</span>
        <button onclick="prevRecordsPage()">ä¸Šä¸€é¡µ</button>
        <span id="currentRecordsPage">1</span>
        <span>/</span>
        <span id="totalRecordsPages">1</span>
        <button onclick="nextRecordsPage()">ä¸‹ä¸€é¡µ</button>
    </div>

    <!-- æ“ä½œæƒé™å¼¹çª— -->
    <div id="authOverlay" class="modal">
        <h3>ğŸ”‘ è¯·è¾“å…¥æ“ä½œå¯†ç </h3>
        <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç ">
        <!-- æ“ä½œäººé€‰æ‹© -->
        <h3>ğŸ‘¤ é€‰æ‹©æ“ä½œäºº</h3>
        <select id="operatorSelect">
            <option value="è†ç‘æ¶›">è†ç‘æ¶›</option>
            <option value="æåœ†">æåœ†</option>
            <option value="éƒ­å®‡">éƒ­å®‡</option>
        </select>
        <div style="text-align:right">
            <button onclick="checkPassword()">âœ… ç¡®è®¤</button>
            <button onclick="closeAuth()" style="background:#95a5a6">âŒ å–æ¶ˆ</button>
        </div>
        <p id="authMessage" style="color:#e74c3c;"></p>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>

    <script>

        // Firebaseé…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„é…ç½®ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyCh-5zkP6EGm-pFoXPDJM1Y7kKDcE2J0-8",
            authDomain: "inventory-management-20f47.firebaseapp.com",
            databaseURL: "https://inventory-management-20f47-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "inventory-management-20f47",
            storageBucket: "inventory-management-20f47.firebasestorage.app",
            messagingSenderId: "985693463831",
            appId: "1:985693463831:web:9cb7421d2ddd0797a2c352"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // å…¨å±€å˜é‡
        const OPERATION_PASSWORD = "youdao123";
        let currentMaterial = null;
        let operationType = "";

        // åˆå§‹åŒ–æ•°æ®
        function initializeData() {
            const ref = database.ref('materials');
            ref.once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    const initialData = {
                        "0": { id:"WP-65-29995", name: "é«˜è€ƒç‰©ç†é«˜é¢‘æ¨¡å‹æ¸…å•", stock: 50, version: "é«˜é¢‘", subject: "ç‰©ç†", image: "" },
                        "1": { id:"WP-128-32406", name: "é«˜è€ƒç”Ÿç‰©é«˜é¢‘æ¨¡å‹æ¸…å•", stock: 100, version: "é«˜é¢‘", subject: "ç”Ÿç‰©", image: "" },
                        "2": { id:"WP-65-29997", name: "å¼ºåŸºè®¡åˆ’æ ¡æµ‹æ•°å­¦æ ‡å‡†æ•™ç¨‹", stock: 40, version: "é«˜é¢‘", subject: "å¼ºåŸºæ•°å­¦", image: "" },
                        "3": { id:"WP-65-29996", name: "å¼ºåŸºè®¡åˆ’æ ¡æµ‹ç‰©ç†æ ‡å‡†æ•™ç¨‹", stock: 10, version: "é«˜é¢‘", subject: "å¼ºåŸºç‰©ç†", image: "" },
                        "4": { id:"WP-128-32397", name: "é«˜è€ƒæ•°å­¦é«˜é¢‘æ¨¡å‹æ¸…å•ï¼ˆä¸Šï¼‰", stock: 6, version: "é«˜é¢‘", subject: "æ•°å­¦", image: "" }
                    };
                    ref.set(initialData);
                }
            });
        }
        window.addEventListener('DOMContentLoaded', () => {
            initializeData();
            renderInventory();
            renderRecords();
        });
        let page = 0;
        const itemsPerPage = 10;
        // å®æ—¶æ¸²æŸ“åº“å­˜
        function renderInventory() {
            const ref = database.ref('materials');
            ref.on('value', (snapshot) => {
                const tbody = document.getElementById('inventoryBody');
                tbody.innerHTML = '';
                const allData = [];
                snapshot.forEach(childSnapshot => {

                    const material = childSnapshot.val();
                    const row = `
                        <tr>
                            <td>${material.id}</td> <!-- æ˜¾ç¤º id -->
                            <td>${material.name}</td>
                            <td>
                                ${material.image ?
                                    `<img src="${material.image}" class="material-image" loading="lazy">` :
                                    'æ— å›¾ç‰‡'}
                                <div class="upload-btn-wrapper">
                                    <button class="upload-btn" onclick="handleImageUpload('${childSnapshot.key}')">ğŸ“¤ ä¸Šä¼ </button>
                                </div>
                            </td>
                            <td>${material.stock}</td>
                            <td>${material.version}</td>
                            <td>${material.subject}</td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="showModal('${material.id}', 'å‡ºåº“')">å‡ºåº“</button>
                                    <button onclick="showModal('${material.id}', 'å…¥åº“')">å…¥åº“</button>
                                </div>
                            </td>

                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
            ref.once('value').then(snapshot => {
                snapshot.forEach(child => {
                    const key = child.key;
                    const data = child.val();
                    if (!data.id) {
                        // æ ¹æ® key æ˜ å°„åˆ°åˆå§‹æ•°æ®ä¸­çš„ id
                        const initialIDs = {
                            "0": "WP-65-29995",
                            "1": "WP-128-32406",
                            "2": "WP-65-29997",
                            "3": "WP-65-29996",
                            "4": "WP-128-32397"
                        };
                        ref.child(key).update({ id: initialIDs[key] });
                    }
                });
            });
            ref.on('value', (snapshot) => {
                const tbody = document.getElementById('inventoryBody');
                tbody.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const material = childSnapshot.val();
                    const row = `
                        <tr>
                            <td>${material.id}</td>
                            <td>${material.name}</td>
                            <td>
                                ${material.image ?
                                    `<img src="${material.image}" class="material-image">` :
                                    'æ— å›¾ç‰‡'}
                                <div class="upload-btn-wrapper">
                                    <button class="upload-btn"
                                        onclick="handleImageUpload('${childSnapshot.key}')">
                                        ğŸ“¤ ä¸Šä¼ 
                                    </button>
                                </div>
                            </td>
                            <td>${material.stock}</td>
                            <td>${material.version}</td>
                            <td>${material.subject}</td>
                            <td>
                                <button onclick="showModal('${childSnapshot.key}', 'å‡ºåº“')">å‡ºåº“</button>
                                <button onclick="showModal('${childSnapshot.key}', 'å…¥åº“')">å…¥åº“</button>
                            </td>

                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // æœç´¢åŠŸèƒ½
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const subject = document.getElementById('subjectFilter').value;
            const version = document.getElementById('versionFilter').value;

            const rows = document.querySelectorAll('#inventoryBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const code = cells[0].textContent.toLowerCase();
                const name = cells[1].textContent.toLowerCase();
                const subj = cells[5].textContent;
                const ver = cells[4].textContent;

                const matchSearch = code.includes(searchTerm) || name.includes(searchTerm);
                const matchSubject = !subject || subj === subject;
                const matchVersion = !version || ver === version;

                row.style.display = (matchSearch && matchSubject && matchVersion) ? '' : 'none';
            });
            // æ¸…ç©ºæœç´¢æ¡†å†…å®¹
            document.getElementById('searchInput').value = '';
        }

        // å¼¹çª—æ“ä½œ
        function showModal(materialId, type) {
            operationType = type;
            const ref = database.ref('materials');
            ref.orderByChild('id').equalTo(materialId).once('value', snapshot => {
                if (snapshot.exists()) {
                    const materialKey = Object.keys(snapshot.val())[0]; // è·å– Firebase key
                    currentMaterial = materialKey; // è¿™é‡Œå­˜çš„æ˜¯ Firebase keyï¼Œä¸æ˜¯ id
                    document.getElementById("modalTitle").textContent = `${type}æ“ä½œ - ${materialId}`;
                    document.getElementById("operationModal").style.display = "block";
                } else {
                    showToast('âŒ æ‹‰å–ç‰©æ–™å¤±è´¥');
                }
            });
        }
        function showToast(message) {
             let toast = document.createElement("div");
             toast.textContent = message;
             toast.style.cssText = `
                 position: fixed;
                 bottom: 20px;
                 left: 50%;
                 transform: translateX(-50%);
                 background: rgba(0, 0, 0, 0.8);
                 color: white;
                 padding: 10px 20px;
                 border-radius: 5px;
                 font-size: 16px;
                 z-index: 9999;
             `;
             document.body.appendChild(toast);
             setTimeout(() => toast.remove(), 3000); // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        }

        function confirmOperation() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const operator = sessionStorage.getItem("currentOperator") || "æœªçŸ¥";
            if (quantity <= 0 || isNaN(quantity)) {
                showToast('âŒ æ“ä½œæ•°é‡å¿…é¡»å¤§äº0');
                return;
            }

            const stockRef = database.ref(`materials/${currentMaterial}/stock`);
            stockRef.once('value').then(snapshot => {
                let currentStock = snapshot.val();
                if (operationType === 'å‡ºåº“' && quantity > currentStock) {
                    showToast(`âŒ å‡ºåº“å¤±è´¥ï¼šåº“å­˜ä¸è¶³ (å½“å‰åº“å­˜ï¼š${currentStock})`);
                    return;
                }

                stockRef.transaction(currentStock => {
                    return operationType === 'å‡ºåº“' ? currentStock - quantity : currentStock + quantity;
                }, (error, committed) => {
                    if (error || !committed) {
                        showToast('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    } else {
                        const materialRef = database.ref(`materials/${currentMaterial}`);
                        materialRef.once('value').then(materialSnapshot => {
                            const materialData = materialSnapshot.val();
                            const recordRef = database.ref('records').push();
                            recordRef.set({
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                type: operationType,
                                code: materialData.id,  // å­˜ç‰©æ–™çš„ id
                                name: materialData.name,
                                quantity: quantity,
                                operator: operator
                            }).then(() => {
                                showToast('âœ… æ“ä½œæˆåŠŸ');
                                closeModal();
                            });
                        }).catch(error => {
                            showToast('âŒ è·å–ç‰©æ–™ä¿¡æ¯å¤±è´¥');
                        });
                    }
                });
            }).catch(error => {
                showToast('âŒ æ— æ³•è·å–åº“å­˜ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥');
            });
        }


        function closeModal() {
            document.getElementById('operationModal').style.display = 'none';
        }

        let currentRecordsPage = 1;
        let recordsPerPage = 15;
        let totalRecordsPages = 1;

        function changeRecordsPerPage() {
            recordsPerPage = parseInt(document.getElementById('recordsPerPageSelect').value);
            currentRecordsPage = 1;
            renderRecords();
        }

        function prevRecordsPage() {
            if (currentRecordsPage > 1) {
                currentRecordsPage--;
                renderRecords();
            }
        }

        function nextRecordsPage() {
            if (currentRecordsPage < totalRecordsPages) {
                currentRecordsPage++;
                renderRecords();
            }
        }

        function updateRecordsPaginationControls(totalRecords) {
            totalRecordsPages = Math.ceil(totalRecords / recordsPerPage);
            document.getElementById('currentRecordsPage').textContent = currentRecordsPage;
            document.getElementById('totalRecordsPages').textContent = totalRecordsPages;
        }

        function renderRecords(filterDate = null) {
            const ref = database.ref('records');
            ref.on('value', (snapshot) => {
                const tbody = document.getElementById('recordBody');
                tbody.innerHTML = '';
                const allRecords = [];
                snapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    const date = new Date(record.timestamp);
                    if (!filterDate || date.toDateString() === new Date(filterDate).toDateString()) {
                        allRecords.push(record);
                    }
                });

                // åˆ†é¡µé€»è¾‘
                const startIndex = (currentRecordsPage - 1) * recordsPerPage;
                const endIndex = startIndex + recordsPerPage;
                const paginatedRecords = allRecords.slice(startIndex, endIndex);

                paginatedRecords.forEach(record => {
                    const date = new Date(record.timestamp);
                    const row = `
                        <tr>
                            <td>${date.toLocaleString()}</td>
                            <td>${record.type}</td>
                            <td>${record.code}</td>
                            <td>${record.name}</td>
                            <td>${record.quantity}</td>
                            <td>${record.operator}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                updateRecordsPaginationControls(allRecords.length);
            });
        }

        function filterRecords() {
            const date = document.getElementById('dateFilter').value;
            renderRecords(date);
        }

        function clearFilter() {
            document.getElementById('dateFilter').value = '';
            renderRecords();
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        initializeData();
        renderInventory();
        renderRecords();


        function showModal(code, type) {
            operationType = type;
            currentMaterial = code;
            document.getElementById("modalTitle").textContent = `${type}æ“ä½œ - ${code}`;
            document.getElementById("operationModal").style.display = "block";
        }


        function closeModal() {
            document.getElementById("operationModal").style.display = "none";
        }

        function verifyAuth() {
            let expireTime = sessionStorage.getItem("authExpireTime");
            if (sessionStorage.getItem("inventoryAuth") && Date.now() < expireTime) {
                confirmOperation(); // å¯†ç è¿˜åœ¨æœ‰æ•ˆæœŸå†…ï¼Œç›´æ¥æ‰§è¡Œæ“ä½œ
            } else {
                sessionStorage.removeItem("inventoryAuth"); // æ¸…é™¤è¿‡æœŸå¯†ç 
                sessionStorage.removeItem("authExpireTime");
                document.getElementById("authOverlay").style.display = "block";// é‡æ–°è¾“å…¥å¯†ç 
            }
        }

        function checkPassword() {
            const input = document.getElementById("passwordInput").value;
            const selectedOperator = document.getElementById("operatorSelect").value; // è·å–æ“ä½œäºº
            if (input === OPERATION_PASSWORD) {
                let expireTime = Date.now() + 10 * 60 * 1000; // å½“å‰æ—¶é—´ + 10 åˆ†é’Ÿ
                sessionStorage.setItem("inventoryAuth", "true");
                sessionStorage.setItem("authExpireTime", Date.now() + 10 * 60 * 1000);
                sessionStorage.setItem("currentOperator", selectedOperator); // å­˜å‚¨æ“ä½œäºº
                document.getElementById("authOverlay").style.display = "none";
                confirmOperation();
            } else {
                document.getElementById("authMessage").textContent = "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•";
            }
        }

        function closeAuth() {
            document.getElementById("authOverlay").style.display = "none";
        }



        function exportRecords() {
            let table = document.getElementById("recordTable");
            let rows = table.querySelectorAll("tr");
            let csvContent = "";

            rows.forEach(row => {
                let cols = row.querySelectorAll("th, td");
                let rowData = [];
                cols.forEach(col => rowData.push(col.innerText));
                csvContent += rowData.join(",") + "\n";
            });

            let blob = new Blob([csvContent], { type: "text/csv" });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "åº“å­˜æ“ä½œè®°å½•.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function handleBatchImport(event) {
            let file = event.target.files[0];
            if (!file) return;

            parseFile(file, async (data) => {
                try {
                    const materialsRef = database.ref('materials');
                    const recordsRef = database.ref('records');
                    const operator = sessionStorage.getItem("currentOperator") || "ç³»ç»Ÿ"; // è®°å½•æ“ä½œäºº

                    // éå†å¯¼å…¥çš„æ•°æ®ï¼Œæ¯æ¡æ•°æ®å¯¹åº”ä¸€ä¸ªå…¥åº“æ“ä½œ
                    const promises = data.map(async (row) => {
                        let id = row['ç¼–ç '] ? row['ç¼–ç '].trim().toUpperCase() : ''; // æ¸…é™¤ç©ºæ ¼ & ç»Ÿä¸€æ ¼å¼
                        const name = row['ç‰©æ–™åç§°'];
                        const quantity = parseInt(row['æ•°é‡']);
                        const version = row['ç‰ˆæœ¬'];
                        const subject = row['å­¦ç§‘'];

                        if (!id || isNaN(quantity)) {
                            showToast(`âŒ æ— æ•ˆæ•°æ®è¡Œï¼š${JSON.stringify(row)}`);
                            return;
                        }

                        // å…ˆæŸ¥æ‰¾è¯¥ id æ˜¯å¦å­˜åœ¨
                        const snapshot = await materialsRef.orderByChild('id').equalTo(id).once('value');

                        if (snapshot.exists()) {
                            const key = Object.keys(snapshot.val())[0]; // è·å– Firebase key
                            await materialsRef.child(`${key}/stock`).transaction(current => (current || 0) + quantity);

                            // âœ… è®°å½•å…¥åº“æ“ä½œ
                            await recordsRef.push({
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                type: "æ‰¹é‡å…¥åº“",
                                code: id,  // è®°å½• `id` è€Œä¸æ˜¯ Firebase `key`
                                name: name,
                                quantity: quantity,
                                operator: operator
                            });
                        } else {
                            // å¦‚æœ id ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ç‰©æ–™è®°å½•
                            const newRef = materialsRef.push();
                            await newRef.set({
                                id: id, // ç¡®ä¿å­˜å‚¨ id
                                name: name,
                                stock: quantity,
                                version: version,
                                subject: subject,
                                image: ""
                            });

                            // âœ… è®°å½•æ–°ç‰©æ–™å…¥åº“
                            await recordsRef.push({
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                type: "æ‰¹é‡å…¥åº“ï¼ˆæ–°å»ºï¼‰",
                                code: id,
                                name: name,
                                quantity: quantity,
                                operator: operator
                            });

                            // åŠ¨æ€æ›´æ–°ç­›é€‰æ çš„ç‰ˆæœ¬å’Œå­¦ç§‘é€‰é¡¹
                            updateFilterOptions(version, subject);
                        }
                    });

                    await Promise.all(promises);
                    showToast('âœ… æ‰¹é‡å…¥åº“æˆåŠŸ');
                    renderInventory(); // åˆ·æ–°å‰ç«¯
                    renderRecords();   // åˆ·æ–°æ“ä½œè®°å½•
                } catch (error) {
                    showToast('âŒ æ‰¹é‡å…¥åº“å¤±è´¥: ' + error.message);
                }
            });
        }


        function handleBatchExport(event) {
            let file = event.target.files[0];
            if (!file) return;

            parseFile(file, async (data) => {
                try {
                    const materialsRef = database.ref('materials');
                    const recordsRef = database.ref('records');
                    const operator = sessionStorage.getItem("currentOperator") || "ç³»ç»Ÿ"; // è®°å½•æ“ä½œäºº

                    const promises = data.map(async (row) => {
                        let id = row['ç¼–ç '] ? row['ç¼–ç '].trim().toUpperCase() : ''; // æ¸…é™¤ç©ºæ ¼ & ç»Ÿä¸€æ ¼å¼
                        const quantity = parseInt(row['æ•°é‡']);

                        if (!id || isNaN(quantity)) {
                            showToast(`âŒ æ— æ•ˆæ•°æ®è¡Œï¼š${JSON.stringify(row)}`);
                            return;
                        }

                        // æŸ¥è¯¢ Firebaseï¼Œç¡®ä¿ id å­˜åœ¨
                        const snapshot = await materialsRef.orderByChild('id').equalTo(id).once('value');

                        if (snapshot.exists()) {
                            const key = Object.keys(snapshot.val())[0]; // è·å– Firebase key
                            const materialData = snapshot.val()[key];  // è·å–å®Œæ•´ç‰©æ–™ä¿¡æ¯
                            const stockRef = materialsRef.child(`${key}/stock`);

                            await stockRef.transaction(currentStock => {
                                if ((currentStock || 0) < quantity) {
                                    showToast(`âŒ ç‰©æ–™ ${id} åº“å­˜ä¸è¶³ï¼Œå‡ºåº“å¤±è´¥`);
                                    return currentStock; // ä¸æ›´æ–°
                                }
                                return currentStock - quantity;
                            });

                            // âœ… è®°å½•å‡ºåº“æ“ä½œ
                            await recordsRef.push({
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                type: "æ‰¹é‡å‡ºåº“",
                                code: id,
                                name: materialData.name,  // ç‰©æ–™åç§°
                                quantity: quantity,
                                operator: operator
                            });

                        } else {
                            showToast(`âŒ ç‰©æ–™ ${id} ä¸å­˜åœ¨ï¼Œå‡ºåº“å¤±è´¥`);
                        }
                    });

                    await Promise.all(promises);
                    showToast('âœ… æ‰¹é‡å‡ºåº“æˆåŠŸ');
                    renderInventory(); // åˆ·æ–°å‰ç«¯
                    renderRecords();   // åˆ·æ–°æ“ä½œè®°å½•
                } catch (error) {
                    showToast('âŒ æ‰¹é‡å‡ºåº“å¤±è´¥: ' + error.message);
                }
            });
        }

        function exportInventory() {
            const ref = database.ref('materials');
            ref.once('value').then(snapshot => {
                let csvContent = "ç¼–ç ,åç§°,åº“å­˜,ç‰ˆæœ¬,å­¦ç§‘\n";
                snapshot.forEach(childSnapshot => {
                    let mat = childSnapshot.val();
                    csvContent += `${mat.id},${mat.name},${mat.stock},${mat.version},${mat.subject}\n`;
                });

                let blob = new Blob([csvContent], { type: "text/csv" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "åº“å­˜æ•°æ®.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
        function parseFile(file, callback) {
            let reader = new FileReader();
            reader.onload = function (e) {
                try { // æ·»åŠ é”™è¯¯å¤„ç†
                    let data = new Uint8Array(e.target.result);
                    let workbook = XLSX.read(data, { type: 'array' });
                    let sheet = workbook.Sheets[workbook.SheetNames[0]];
                    let json = XLSX.utils.sheet_to_json(sheet);
                    callback(json);
                } catch (error) {
                    showToast('âŒ æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                }
            };
            reader.onerror = () => showToast('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
            reader.readAsArrayBuffer(file);
        }
        function handleImageUpload(materialCode) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    const img = new Image();
                    img.src = readerEvent.target.result;
                    img.onload = function () {
                        // 1. åˆ›å»ºä¸€ä¸ª canvas è¿›è¡Œå‹ç¼©
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 2. è®¾ç½®æœ€å¤§å®½åº¦å’Œé«˜åº¦ï¼ˆä¾‹å¦‚ 800px å®½åº¦ï¼Œé«˜åº¦æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼‰
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let { width, height } = img;

                        // æŒ‰æ¯”ä¾‹ç¼©æ”¾å›¾ç‰‡
                        if (width > maxWidth || height > maxHeight) {
                            const scale = Math.min(maxWidth / width, maxHeight / height);
                            width *= scale;
                            height *= scale;
                        }

                        // è®¾ç½® canvas å°ºå¯¸
                        canvas.width = width;
                        canvas.height = height;

                        // 3. å¡«å……ç™½è‰²èƒŒæ™¯
                        ctx.fillStyle = '#FFFFFF'; // è®¾ç½®èƒŒæ™¯ä¸ºç™½è‰²
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // 4. ç»˜åˆ¶å›¾ç‰‡åˆ° canvas
                        ctx.drawImage(img, 0, 0, width, height);

                        // 5. å°†å›¾ç‰‡è½¬æ¢ä¸º Base64ï¼ˆæé«˜ JPEG è´¨é‡åˆ° 0.8ï¼‰
                        const compressedBase64 = canvas.toDataURL('image/webp', 0.8);

                        // 6. å­˜å…¥ Firebase Realtime Database
                        database.ref(`materials/${materialCode}/image`).set(compressedBase64)
                            .then(() => {
                                showToast('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                                renderInventory(); // åˆ·æ–°é¡µé¢
                            })
                            .catch(error => {
                                showToast('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                            });
                    };
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        function updateFilterOptions(version, subject) {
            const versionFilter = document.getElementById('versionFilter');
            const subjectFilter = document.getElementById('subjectFilter');

            // æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²ç»å­˜åœ¨
            let versionExists = false;
            for (let option of versionFilter.options) {
                if (option.value === version) {
                    versionExists = true;
                    break;
                }
            }
            if (!versionExists && version) {
                const newOption = document.createElement('option');
                newOption.value = version;
                newOption.textContent = version;
                versionFilter.appendChild(newOption);
            }

            // æ£€æŸ¥å­¦ç§‘æ˜¯å¦å·²ç»å­˜åœ¨
            let subjectExists = false;
            for (let option of subjectFilter.options) {
                if (option.value === subject) {
                    subjectExists = true;
                    break;
                }
            }
            if (!subjectExists && subject) {
                const newOption = document.createElement('option');
                newOption.value = subject;
                newOption.textContent = subject;
                subjectFilter.appendChild(newOption);
            }
        }



    </script>

</body>
</html>
